---
title: "Untitled"
author: "Miguel Rodo"
date: "13/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r , include = FALSE}
library(magrittr)
library(stringr)
```

```{r }
dir_save_csv <- file.path("inst", "extdata", "csv")
if (dir.exists(dir_save_csv)) unlink(dir_save_csv, recursive = TRUE)
dir.create(dir_save_csv, recursive = TRUE)
```

```{r , include = FALSE}
unlink(here::here("data"))
dir_data_raw <- file.path(
  dirname(here::here()), 
  "DataRawGelaDURT"
)
long_to_short_pop <- c(
  "MAIT cells" = "mait", 
  "NKT cells" = "nkt", 
  "CD1b-GMM" = "cd1b", 
  "CD1b-GMM T cells" = "cd1b", 
  "GEM T cells" = "gem", 
  "gd T cells" = "gd", 
  "CD4 Tcells" = "cd4", 
  "CD4 T cells" = "cd4", 
  "CD4+ T cells" = "cd4", 
  "IFNg+ CD4 T cells" = "cd4_ifng"
)
```

## Lineage frequencies (Figure 2)

```{r , include = FALSE}
sheet_vec <- c(
  "MAIT cells", 
  "NKT cells", 
  "CD1b-GMM", 
  "GEM T cells", 
  "gd T cells", 
  "CD4 Tcells", 
  "IFNg+ CD4 T cells"
)

dir_data_raw <- file.path(
  dirname(here::here()), 
  "DataRawGelaDURT"
)
path_data_raw <- file.path(
  dir_data_raw, 
  "2021_09_16,Gela,email-Fig. 2 Frequencies.xlsx"
)

data_tidy_freq <- purrr::map_df(sheet_vec, function(sheet) {
  print(sheet)
  data_raw <- readxl::read_xlsx(
    file.path(
      path_data_raw 
    ), 
    sheet = sheet
  ) %>%
    dplyr::mutate(
      pop = sheet
    ) 
  
  data_raw <- data_raw %>%
    dplyr::rename(
      pid_infant_bcg_no = `ID (D-BCG)...6`, 
      pid_infant_bcg = `ID (D-BCG)...13`, 
      pid_adult = `Sample ID`
    )

  # align PIDs using Melissa's response data
  if (sheet == "IFNg+ CD4 T cells") {
    data_raw_order <- readxl::read_xlsx(
      file.path(
        path_data_raw 
      ), 
      sheet = "CD4 Tcells"
    ) %>%
      dplyr::mutate(
        pop = "CD4 Tcells"
      ) 
    
    data_raw_order <- data_raw_order %>%
      dplyr::rename(
        pid_infant_bcg_no = `ID (D-BCG)...6`, 
        pid_infant_bcg = `ID (D-BCG)...13`, 
        pid_adult = `Sample ID`
      ) %>%
      dplyr::select(
        pid_infant_bcg_no, 
        pid_infant_bcg, 
        pid_adult, 
        pop,
        `No BCG`:After
      ) 
    data_raw_order_infant_bcg <- data_raw_order %>%
      dplyr::select(pid_infant_bcg, pop, `BCG`) %>%
      dplyr::rename(pid_sheet = pid_infant_bcg) %>%
      dplyr::mutate(bcg = "bcg") %>%
      dplyr::rename(freq = `BCG`) %>%
      dplyr::mutate(age = "infant") %>%
      dplyr::mutate(row = 25 + seq_len(dplyr::n())) %>%
      dplyr::mutate(row = ifelse(
        str_length(row) == 1, 
        paste0("0", row),
        row)) %>%
      dplyr::mutate(pid = paste0(age, "_", row)) %>%
      dplyr::select(pid, pid_sheet, bcg, age, pop, freq) %>%
      dplyr::filter(!is.na(freq))
    
    sheet_to_r_pid_ifng_bcg_f25 <- setNames(
      data_raw_order_infant_bcg$pid, 
      data_raw_order_infant_bcg$pid_sheet
    )
    
    data_raw_infant_bcg_f25 <- data_raw %>%
      dplyr::select(pid_infant_bcg, pop, `BCG`,
                    `Race...16`, `Sex...17`, `Age (weeks)...18`) %>%
      dplyr::rename(
        race = `Race...16`,
        sex = `Sex...17`, 
        visit_age = `Age (weeks)...18`
      ) %>%
      dplyr::rename(pid_sheet = pid_infant_bcg) %>%
      dplyr::mutate(pid_sheet = as.character(pid_sheet)) %>%
      dplyr::filter(pid_sheet %in% names(sheet_to_r_pid_ifng_bcg_f25)) %>%
      dplyr::mutate(bcg = "bcg") %>%
      dplyr::rename(freq = `BCG`) %>%
      dplyr::mutate(age = "infant") %>%
      dplyr::mutate(pid = sheet_to_r_pid_ifng_bcg_f25[pid_sheet]) %>%
      dplyr::select(pid, pid_sheet, bcg, age, race, sex, visit_age, pop, freq) %>%
      dplyr::filter(!is.na(freq))
    
    data_raw_infant_bcg_s25 <- data_raw %>%
      dplyr::select(pid_infant_bcg, pop, `BCG`,
                    `Race...16`, `Sex...17`, `Age (weeks)...18`) %>%
      dplyr::rename(
        race = `Race...16`,
        sex = `Sex...17`, 
        visit_age = `Age (weeks)...18`
      ) %>%
      dplyr::rename(pid_sheet = pid_infant_bcg) %>%
      dplyr::mutate(pid_sheet = as.character(pid_sheet)) %>%
      dplyr::filter(!pid_sheet %in% names(sheet_to_r_pid_ifng_bcg_f25)) %>%
      dplyr::mutate(bcg = "bcg") %>%
      dplyr::rename(freq = `BCG`) %>%
      dplyr::mutate(age = "infant") %>%
      dplyr::mutate(row = 50 + seq_len(dplyr::n())) %>%
      dplyr::mutate(row = ifelse(
        str_length(row) == 1, 
        paste0("0", row),
        row)) %>%
      dplyr::mutate(pid = paste0(age, "_", row)) %>%
      dplyr::select(pid, pid_sheet, bcg, age, race, sex, visit_age, pop, freq) %>%
      dplyr::filter(!is.na(freq))
    
    data_raw_infant_bcg <- data_raw_infant_bcg_f25 %>%
      dplyr::bind_rows(data_raw_infant_bcg_s25)
    
    pid_to_race_inf_bcg <- setNames(
      data_raw_infant_bcg$race, 
      data_raw_infant_bcg$pid
    )
    pid_to_sex_inf_bcg <- setNames(
      data_raw_infant_bcg$sex, 
      data_raw_infant_bcg$pid
    )
    pid_to_visit_age_inf_bcg <- setNames(
      data_raw_infant_bcg$visit_age, 
      data_raw_infant_bcg$pid
    )
    
    assign(
      x = "pid_to_race_inf_bcg", 
      value = pid_to_race_inf_bcg, 
      envir = rlang::caller_env(n = 3)
    )
    assign(
      x = "pid_to_sex_inf_bcg", 
      value = pid_to_sex_inf_bcg, 
      envir = rlang::caller_env(n = 3)
    )
    assign(
      x = "pid_to_visit_age_inf_bcg", 
      value = pid_to_visit_age_inf_bcg, 
      envir = rlang::caller_env(n = 3)
    )

    
    data_raw_infant_bcg <- data_raw_infant_bcg %>%
      dplyr::select(-c(visit_age, race, sex))
    
  } else {
    data_raw_infant_bcg <- data_raw %>%
      dplyr::select(pid_infant_bcg, pop, `BCG`) %>%
      dplyr::rename(pid_sheet = pid_infant_bcg) %>%
      dplyr::mutate(bcg = "bcg") %>%
      dplyr::rename(freq = `BCG`) %>%
      dplyr::mutate(age = "infant") %>%
      dplyr::mutate(row = 25 + seq_len(dplyr::n())) %>%
      dplyr::mutate(row = ifelse(
        str_length(row) == 1, 
        paste0("0", row),
        row)) %>%
      dplyr::mutate(pid = paste0(age, "_", row)) %>%
      dplyr::select(pid, pid_sheet, bcg, age, pop, freq) %>%
      dplyr::filter(!is.na(freq)) %>%
    dplyr::mutate(pid_sheet = as.character(pid_sheet))
  }
  
  data_raw_infant_bcg_no <- data_raw %>%
    dplyr::select(pid_infant_bcg_no, pop, `No BCG`) %>%
    dplyr::rename(pid_sheet = pid_infant_bcg_no) %>%
    dplyr::mutate(bcg = "no bcg") %>%
    dplyr::rename(freq = `No BCG`) %>%
    dplyr::mutate(age = "infant") %>%
    dplyr::mutate(row = seq_len(dplyr::n())) %>%
    dplyr::mutate(row = ifelse(
      str_length(row) == 1, 
      paste0("0", row),
      row)) %>%
    dplyr::mutate(pid = paste0(age, "_", row)) %>%
    dplyr::select(pid, pid_sheet, bcg, age, pop, freq) %>%
    dplyr::filter(!is.na(freq)) %>%
    dplyr::mutate(pid_sheet = as.character(pid_sheet))
  
  data_raw_adult <- data_raw %>%
    dplyr::select(pid_adult, pop, Before, After) %>%
    dplyr::rename(pid_sheet = pid_adult) %>%
    dplyr::mutate(row = seq_len(dplyr::n())) %>%
    dplyr::mutate(row = ifelse(
      str_length(row) == 1, 
      paste0("0", row),
      row)) %>%
    dplyr::mutate(age = "adult") %>%
    dplyr::mutate(pid = paste0(age, "_", row)) %>%
    dplyr::select(-row) %>%
    tidyr::pivot_longer(
      -c(pid_sheet, pop, pid, age), 
      names_to = "bcg", 
      values_to = "freq"
    ) %>%
    dplyr::mutate(bcg = tolower(bcg)) %>%
    dplyr::select(pid, pid_sheet, bcg, age, pop, freq) %>%
    dplyr::filter(!is.na(freq)) %>%
    dplyr::mutate(pid_sheet = as.character(pid_sheet))
  
  data_out <- data_raw_infant_bcg_no %>%
    dplyr::bind_rows(
      data_raw_infant_bcg
    ) %>%
    dplyr::bind_rows(
      data_raw_adult
    ) %>%
    dplyr::mutate(
      bcg = tolower(bcg), 
      pop = long_to_short_pop[pop]
    ) %>%
    dplyr::select(-age) %>%
    dplyr::mutate(
      pid = setNames(pid, NULL), 
      bcg = setNames(bcg, NULL), 
      pop = setNames(pop, NULL), 
      freq = setNames(freq, NULL))
  
  if (sheet == "IFNg+ CD4 T cells") {
    
    data_out_infant <- data_out %>%
      dplyr::filter(grepl("infant", pid))
    
    sheet_to_r_pid_infant_ifng <- setNames(
      setNames(data_out_infant$pid, NULL),
      setNames(data_out_infant$pid_sheet, NULL)
    )
    assign(
      x = "sheet_to_r_pid_infant_ifng", 
      value = sheet_to_r_pid_infant_ifng, 
      envir = rlang::caller_env(n = 3)
    )
  }
  data_out

}) %>%
  tibble::as_tibble() %>%
  dplyr::select(-pid_sheet)
```

```{r }
datautils::view_cols(
  data_tidy_freq
)
```

```{r , include = FALSE}
usethis::use_data(data_tidy_freq, 
                  overwrite = TRUE)
```

```{r }
readr::write_csv(
  x = data_tidy_freq, 
  file = file.path(dir_save_csv, "data_tidy_freq.csv")
)
```

## HLADR MFI: Infants (Figure 3)

```{r , include = FALSE}
sheet_vec <- c(
  "CD4+ T cells",
  "MAIT cells", 
  "NKT cells", 
  "CD1b-GMM T cells", 
  "gd T cells"
)

path_data_raw <- file.path(
  dir_data_raw, 
  "2021_09_16,Gela,email-Fig. 3 Activation profile_infants.xlsx"
)
data_tidy_hladr_infant <- purrr::map_df(sheet_vec, function(sheet) {
  data_raw <- readxl::read_xlsx(
    file.path(
      path_data_raw 
    ), 
    sheet = sheet
  ) %>%
    dplyr::mutate(
      pop = sheet
    )
  if(nrow(data_raw) == 0) print(sheet)
  
  cn_vec <- colnames(data_raw)
  id_vec_ind <- which(grepl("ID \\(D-BCG\\)", cn_vec))
  cn_vec_id <- cn_vec[id_vec_ind]
  data_raw <- data_raw[,c("pop", "No BCG", "BCG", cn_vec_id)]
  colnames(data_raw) <- c(
    colnames(data_raw)[1:3], 
    "pid_infant_bcg_no",
    "pid_infant_bcg"
  )

  data_raw_infant_bcg_no <- data_raw %>%
    dplyr::select(pid_infant_bcg_no, pop, `No BCG`) %>%
    dplyr::rename(pid_sheet = pid_infant_bcg_no) %>%
    dplyr::mutate(bcg = "no bcg") %>%
    dplyr::rename(hladr_mfi = `No BCG`) %>%
    dplyr::mutate(age = "infant") %>%
    dplyr::mutate(row = seq_len(dplyr::n())) %>%
    dplyr::mutate(row = ifelse(
      str_length(row) == 1, 
      paste0("0", row),
      row)) %>%
    dplyr::mutate(pid = paste0(age, "_", row)) %>%
    dplyr::select(pid, pid_sheet, bcg, age, pop, hladr_mfi) %>%
    dplyr::filter(!is.na(hladr_mfi))
  
  data_raw_infant_bcg <- data_raw %>%
    dplyr::select(pid_infant_bcg, pop, `BCG`) %>%
    dplyr::rename(pid_sheet = pid_infant_bcg) %>%
    dplyr::mutate(bcg = "bcg") %>%
    dplyr::rename(hladr_mfi = `BCG`) %>%
    dplyr::mutate(age = "infant") %>%
    dplyr::mutate(row = seq_len(dplyr::n()) + 25) %>%
    dplyr::mutate(row = ifelse(
      str_length(row) == 1, 
      paste0("0", row),
      row)) %>%
    dplyr::mutate(pid = paste0(age, "_", row)) %>%
    dplyr::select(pid, pid_sheet, bcg, age, pop, hladr_mfi) %>%
    dplyr::filter(!is.na(hladr_mfi))
  
  if(sheet == "CD4+ T cells") {
    data_raw <- readxl::read_xlsx(
      file.path(
        path_data_raw 
      ), 
      sheet = sheet
    ) %>%
      dplyr::mutate(
        pop = "cd4_ifng"
      )
    if(nrow(data_raw) == 0) print(sheet)
  
    cn_vec <- colnames(data_raw)
    id_vec_ind <- which(grepl("ID \\(D-BCG\\)", cn_vec))
    data_raw <- data_raw[, c(18, 3, id_vec_ind[2])]
    colnames(data_raw) <- c("pop", "hladr_mfi", "pid_sheet")
    
    data_raw_infant_bcg_cd4_ifng <- data_raw %>%
      dplyr::select(pid_sheet, pop, hladr_mfi) %>%
      dplyr::mutate(bcg = "bcg") %>%
      dplyr::mutate(age = "infant") %>%
      dplyr::mutate(row = seq_len(dplyr::n()) + 25) %>%
      dplyr::mutate(row = ifelse(
        str_length(row) == 1, 
        paste0("0", row),
        row)) %>%
      dplyr::mutate(pid = paste0(age, "_", row)) %>%
      dplyr::select(pid, pid_sheet, bcg, age, pop, hladr_mfi) %>%
      dplyr::filter(!is.na(hladr_mfi))

  }
  
  data_out <- data_raw_infant_bcg_no %>%
    dplyr::bind_rows(
      data_raw_infant_bcg
    ) %>%
    dplyr::mutate(
      pop = long_to_short_pop[pop]
    )
  if (sheet == "CD4+ T cells") {
    data_out <- data_out %>%
      dplyr::bind_rows(
        data_raw_infant_bcg_cd4_ifng
      )
  }

  data_out %>%
    dplyr::mutate(
      bcg = tolower(bcg)
    ) %>%
    dplyr::select(-age) %>%
    dplyr::mutate(
      pid = sheet_to_r_pid_infant_ifng[as.character(pid_sheet)]
    ) %>%
    dplyr::select(-pid_sheet)
}) %>%
  tibble::as_tibble()
```


```{r }
datautils::view_cols(
  data_tidy_hladr_infant
)
```

```{r , include = FALSE}
usethis::use_data(
  data_tidy_hladr_infant,
  overwrite = TRUE
  )
```

```{r }
readr::write_csv(
  x = data_tidy_hladr_infant, 
  file = file.path(dir_save_csv, "data_tidy_hladr_infant.csv")
)
```


## HLADR MFI: Adults (Figure 4)

```{r , include = FALSE}
sheet_vec <- c(
  "MAIT cells", 
  "NKT cells", 
  "CD1b-GMM", 
  "gd T cells", 
  "CD4 T cells"
)

path_data_raw <- file.path(
  dir_data_raw, 
  "2021_09_16,Gela,email-Fig.4 Activation profile adults.xlsx"
)
data_tidy_hladr_adult <- purrr::map_df(sheet_vec, function(sheet) {
  data_raw <- readxl::read_xlsx(
    file.path(
      path_data_raw 
    ), 
    sheet = sheet, 
    n_max = 25,
  ) %>%
    dplyr::select(`0`:`365`, `Sample ID`) %>%
    dplyr::mutate(
      pop = sheet,
      age = "adult",
      row = 1:(dplyr::n())
    )  %>%
    dplyr::mutate(
      pid = paste0(
        age,
        "_",
        ifelse(str_length(row) == 1, 
               paste0("0", row), row))
    ) %>%
    dplyr::rename(pid_sheet = `Sample ID`) %>%
    dplyr::select(-c(row, age))
  data_raw %>%
    tidyr::pivot_longer(
      -c(pid, pid_sheet, pop), 
      names_to = "days", 
      values_to = "hladr_mfi"
    ) %>%
    dplyr::select(
      pid, pop, days, hladr_mfi
    ) %>%
    dplyr::mutate(
      pop = long_to_short_pop[pop]
    ) %>%
    dplyr::mutate(
      days = as.integer(days)
    )
}) %>%
  tibble::as_tibble()
```

```{r }
datautils::view_cols(
  data_tidy_hladr_adult
)
```

```{r , include = FALSE}
usethis::use_data(data_tidy_hladr_adult, 
                  overwrite = TRUE)
```

```{r }
readr::write_csv(
  x = data_tidy_hladr_adult, 
  file = file.path(dir_save_csv, "data_tidy_hladr_adult.csv")
)
```

## IFN$\gamma$+ frequency: Infants (Figure 5)

```{r }
path_data_raw <- file.path(
  dir_data_raw, 
  "2021_10_11,Murphy,email-20211011_Raw data for figure 5 of DURT manuscript.xlsx"
)

sheet_vec <- c(
  "Figure 5B-main flow panel", 
  "Figure 5D- 9W flow panel", 
  "Figure 5F- 9W flow panel", 
  "Figure 5G- 9W flow panel" 
)

sheet_to_pop <- setNames(
  c("gd", "cd26_161", "cd26_161", "cd26_161"),
  sheet_vec
)
sheet <- sheet_vec[1]
long_to_short_pop_sub <- c(
  "IFNg+GDTCR+" = "-", 
  "IFNg+CD3+" = "-",
  "G+CD8+" = "cd8p_cd4n",
  "G+CD8-CD4-" = "cd8n_cd4n",
  "G+CD4+" = "cd8n_cd4p",
  "TRAV1-2+" = "trav12p", 
  "TRAV1-2-" = "trav12n"
)
data_tidy_freq_ifng <- purrr::map_df(sheet_vec, function(sheet) {
  readxl::read_xlsx(
    file.path(
      path_data_raw 
    ), 
    sheet = sheet 
  ) %>%
    dplyr::rename(
      pid_sheet = PID, 
      bcg = `Vaccination status`
    ) %>%
    dplyr::mutate(
      pid_sheet = as.character(pid_sheet)
    ) %>%
    dplyr::mutate(
      pid = sheet_to_r_pid_infant_ifng[pid_sheet], 
      pid = ifelse(is.na(pid), pid_sheet, pid)
    ) %>%
    dplyr::mutate(
      pid = purrr::map_chr(pid, function(x) {
        switch(
          x, 
          "3103" = "infant_76", 
          "5078" = "infant_77", 
          "5139" = "infant_78", 
          x
        )
      })
    ) %>%
    dplyr::mutate(
      pop = sheet_to_pop[sheet]
    ) %>%
    tidyr::pivot_longer(
      -c(pid_sheet, pid, bcg, pop), 
      names_to = "pop_sub", 
      values_to = "freq_ifng"
    ) %>%

    dplyr::select(
      pid, bcg, pop, pop_sub, freq_ifng
    ) %>%
    dplyr::mutate(
      pop_sub = long_to_short_pop_sub[pop_sub]
    ) %>%
    dplyr::mutate(
      bcg = ifelse(bcg == "BCG", "bcg", bcg), 
      bcg = ifelse(bcg == "NO BCG", "no bcg", bcg)
    ) 
}) %>%
  tibble::as_tibble()
```

```{r }
datautils::view_cols(
  data_tidy_freq_ifng
)
```

```{r , include = FALSE}
usethis::use_data(
  data_tidy_freq_ifng, 
  overwrite = TRUE
  )
```

```{r }
readr::write_csv(
  x = data_tidy_freq_ifng, 
  file = file.path(dir_save_csv, "data_tidy_freq_ifng.csv")
)
```


## Memory profile (Figure 6)

```{r , include = FALSE}                           
sheet_vec <- c(
  "MAIT cells", 
  "NKT cells", 
  "gd T cells", 
  "CD4 T cells"
)
path_data_raw <- file.path(
  dir_data_raw, 
  "2021_10_02,Gela,email-Figure 6- Memory profile.xlsx"
)
data_tidy_mem <- purrr::map_df(sheet_vec, function(sheet) {
  data_raw <- readxl::read_xlsx(
    file.path(
      path_data_raw 
    ), 
    sheet = sheet, 
    skip = 2, 
    col_names = FALSE
  )
  data_raw_pop <- readxl::read_xlsx(
    file.path(
      path_data_raw 
    ), 
    sheet = sheet, 
    n_max = 1,
    skip = 0
  )
  info_tbl <- data_raw_pop %>%
    dplyr::mutate(id = 1) %>%
    tidyr::pivot_longer(
      -id, 
      names_to = "grp", 
      values_to = "pop"
    ) %>%
    dplyr::mutate(
      grp = stringr::str_replace_all(
        grp, " ", "_"
      )
    )
  for (i in seq_len(nrow(info_tbl))) {
    if (is.na(info_tbl$pop[[i]])) {
      info_tbl[i, "pop"] <- info_tbl[i - 1, "pop"]
    }
  }
  cn_vec <- paste0(info_tbl$grp, info_tbl$pop)
  colnames(data_raw) <- cn_vec
  
  cn_vec_sel <- cn_vec[
    grepl("^Adult|^No|^BCG", cn_vec)  
  ]
  data_raw <- data_raw[,cn_vec_sel]
  
  data_raw %>%
    dplyr::mutate(
      row = seq_len(dplyr::n()),
      row = as.character(row),
      row = ifelse(
        stringr::str_length(row) == 1, 
        paste0("0", row),
        row
        ),
    ) %>%
    #dplyr::mutate(pid = paste0("adult_", row)) %>%
    #::select(-row) %>%
    tidyr::pivot_longer(
      -row, 
      names_to = "var", 
      values_to = "freq"
    ) %>%
    dplyr::mutate(
      age =  ifelse(grepl("^Adult", var), "adult", ""),
      age =  ifelse(grepl("^No_BCG|^BCG", var), "infant", age),
    ) %>%
    dplyr::mutate(
      pid = paste0(age, "_", row)
    ) %>%
    dplyr::mutate(
      pop_sub = stringr::str_sub(stringr::str_remove_all(var, "\\s"),
                                 start = - 12)
    ) %>%
    dplyr::mutate(
      grp = stringr::str_remove_all(var, "Adult_Day_"), 
      grp = stringr::str_remove_all(grp, "CCR7") %>%
        stringr::str_remove_all("CD45RA") %>%
        stringr::str_remove_all("\\+|\\-") %>%
        stringr::str_remove_all("\\.\\.\\.\\d+"), 
      grp = as.numeric(grp)
    ) %>%
    dplyr::mutate(
      grp = ifelse(age == "infant" & grepl("^No_BCG", var), 
                   "no bcg", grp),
      grp = ifelse(age == "infant" & grepl("^BCG", var), 
                   "bcg", grp)
    ) %>%
    dplyr::select(-var) %>%
    dplyr::mutate(
      pop = long_to_short_pop[sheet]
    ) %>%
    dplyr::select(pid, age, grp, pop, pop_sub, freq)
}) %>%
  tibble::as_tibble() 

data_tidy_mem <- data_tidy_mem %>%
  dplyr::mutate(
    pop_sub = purrr::map_chr(pop_sub, function(x) {
      switch(
        x, 
        "CCR7+CD45RA+" = "CD45RA+CCR7+", 
        x
      )
    })
  )
```

```{r }
datautils::view_cols(
  data_tidy_mem
)
```

```{r , include = FALSE}
usethis::use_data(
  data_tidy_mem, 
  overwrite = TRUE
  )
```

```{r }
readr::write_csv(
  x = data_tidy_mem, 
  file = file.path(dir_save_csv, "data_tidy_mem.csv")
)
```

## Clinical data - Infants

### Copy of delayed BCG samples for Anele_.xlsx

We read in the clinical data from `Copy of delayed BCG samples for Anele_.xlsx`. This was the spreadsheet originally provided to get the clinical data from. However, it did not have the gender for the infants and did not have the PIDs for the extra twenty-five infants who were given BCG at birth and had their CD4 T cell IFN$\gamma$ frequency measured. It did, however, provide the following extra variables: gestational age, weight, length and head circumference. In addition, it provides a check on the data read in from the other spreadsheet giving clinical data regarding the infants. 

```{r , include = FALSE}
path_data_raw <- file.path(
  dir_data_raw, 
  "Copy of delayed BCG samples for Anele_.xlsx"
)
data_tidy_clin_infant_bcg <- readxl::read_xlsx(
  path_data_raw, 
  skip = 4, 
  n_max = 25
  ) %>%
  dplyr::mutate(bcg = "bcg") %>%
  dplyr::mutate(age = "infant") %>%
    dplyr::mutate(row = seq_len(dplyr::n())) %>%
    dplyr::mutate(row = ifelse(
      str_length(row) == 1, 
      paste0("0", row),
      row)) %>%
  dplyr::mutate(pid_r = paste0(age, "_", row)) %>%
  dplyr::select(-c(row, age))

data_tidy_clin_infant_bcg_no <- readxl::read_xlsx(
  path_data_raw, 
  skip = 32, 
  n_max = 25, 
  col_names = FALSE
  ) %>%
  dplyr::mutate(bcg = "no bcg") %>%
  dplyr::mutate(age = "infant") %>%
  dplyr::mutate(row = seq_len(dplyr::n()) + 25) %>%
  dplyr::mutate(row = ifelse(
    str_length(row) == 1, 
    paste0("0", row),
    row)) %>%
  dplyr::mutate(pid_r = paste0(age, "_", row)) %>%
  dplyr::select(-c(row, age))
  
colnames(data_tidy_clin_infant_bcg_no) <- colnames(data_tidy_clin_infant_bcg)

data_tidy_clin_infant <- data_tidy_clin_infant_bcg %>%
  dplyr::bind_rows(data_tidy_clin_infant_bcg_no)

data_tidy_clin_infant <- data_tidy_clin_infant %>%
  dplyr::select(pid_r, PID, BabyEthnicGroup, GestationalAgeWeeks, BirthWeight:BirthHeadCirc, bcg) %>%
  dplyr::rename(pid_sheet = PID, 
                ethnicity = BabyEthnicGroup, 
                gest_age = GestationalAgeWeeks, 
                weight = BirthWeight, 
                length = BirthLength, 
                head_circ = BirthHeadCirc)
data_tidy_clin_infant <- data_tidy_clin_infant %>%
  dplyr::mutate(
    pid_sheet = as.character(pid_sheet)
  ) %>%
  dplyr::mutate(
    age = "infant"
  ) %>%
  dplyr::rename(pid = pid_r)

data_tidy_clin_infant_lab <- data_tidy_clin_infant %>%
  dplyr::group_by(pid_sheet, pid) %>%
  dplyr::slice(1) %>%
  dplyr::ungroup() %>%
  dplyr::select(pid_sheet, pid)
r_to_sheet_pid_infant <- setNames(data_tidy_clin_infant_lab$pid_sheet, 
                                  data_tidy_clin_infant_lab$pid)
sheet_to_r_pid_infant <- setNames(names(r_to_sheet_pid_infant), 
                                  r_to_sheet_pid_infant)

data_tidy_clin_infant <- data_tidy_clin_infant 

data_tidy_clin_infant <- data_tidy_clin_infant %>%
  dplyr::rename(race = ethnicity)
chr_to_num_race_infant <- c("coloured" = "2", 
                            "black" = "1")
data_tidy_clin_infant <- data_tidy_clin_infant %>%
  dplyr::mutate(
    race = chr_to_num_race_infant[race]
  ) %>%
  dplyr::mutate(age = "infant")
```

#### Checks

```{r }
testthat::expect_identical(nrow(data_tidy_clin_infant), 50L)
testthat::expect_identical(unique(data_tidy_clin_infant$race),
                           c("2", "1"))
testthat::expect_identical(unique(data_tidy_clin_infant$bcg),
                           c("bcg", "no bcg"))
```

#### View

```{r }
datautils::view_cols(
  data_tidy_clin_infant
)
```

### 2021_09_16,Gela,email-Fig. 2 Frequencies.xlsx

We read in the clinical data from `2021_09_16,Gela,email-Fig. 2 Frequencies.xlsx`. This was provided after realising that the previous infant clinical data spreadsheet did not have the PIDs for all the infants and did not provide the key potential confounder, sex. 

```{r , include = FALSE}
path_data_raw <- file.path(
  dir_data_raw, 
  "2021_09_16,Gela,email-Fig. 2 Frequencies.xlsx"
)
data_tidy_clin_infant_raw_anele <- readxl::read_excel(
  path_data_raw, 
  sheet = "IFNg+ CD4 T cells", 
  n_max = 50
)
data_tidy_clin_infant_bcg_anele <- data_tidy_clin_infant_raw_anele %>%
  dplyr::select(`ID (D-BCG)...13`, `Race...16`:`Age (weeks)...18`) %>%
  dplyr::rename(pid_sheet = `ID (D-BCG)...13`, 
                race = `Race...16`,
                sex = `Sex...17`,
                visit_age = `Age (weeks)...18`) %>%
  dplyr::mutate(bcg = "bcg") %>%
  dplyr::mutate(pid_r_anele = paste0("infant_", 26:75))

data_tidy_clin_infant_bcg_no_anele <- data_tidy_clin_infant_raw_anele %>%
  dplyr::select(`ID (D-BCG)...6`, `Race...9`:`Age (weeks)...11`) %>%
  dplyr::rename(pid_sheet = `ID (D-BCG)...6`, 
                race = `Race...9`,
                sex = `Sex...10`,
                visit_age = `Age (weeks)...11`) %>%
  dplyr::mutate(bcg = "no bcg") %>%
  dplyr::filter(!is.na(pid_sheet)) %>%
  dplyr::mutate(row = seq_len(dplyr::n())) %>%
  dplyr::mutate(row = ifelse(
      str_length(row) == 1, 
      paste0("0", row),
      row)) %>%
  dplyr::mutate(pid_r_anele = paste0("infant_", row)) %>%
  dplyr::select(-row)
data_tidy_clin_infant_anele <- data_tidy_clin_infant_bcg_anele %>%
  dplyr::bind_rows(data_tidy_clin_infant_bcg_no_anele) %>%
  dplyr::mutate(pid_sheet = as.character(pid_sheet)) 

chr_to_num_sex_infant_anele <- c("F" = "2", "M" = "1")
chr_to_num_race_infant_anele <- c("black" = "1", "coloured" = "2")

data_tidy_clin_infant_anele <- data_tidy_clin_infant_anele %>%
  dplyr::mutate(
    race = chr_to_num_race_infant_anele[race], 
    sex = chr_to_num_sex_infant_anele[sex]
  )

sheet_to_r_pid_infant_anele <- setNames(data_tidy_clin_infant_anele$pid_r_anele, 
                                        data_tidy_clin_infant_anele$pid_sheet)
```

Based on below, it appears that the rows are ordered differently between `Copy of delayed BCG samples for Anele_.xlsx` and the immunological data, e.g. `2021_09_16,Gela,email-Fig. 2 Frequencies.xlsx` spreadsheeet `IFNg+ CD4 T cells`. 
```{r }
sheet_to_r_pid_infant_anele_check <- sheet_to_r_pid_infant_anele[
  as.numeric(gsub("infant_", "", sheet_to_r_pid_infant_anele)) <= 50
]

purrr::map(seq_along(sheet_to_r_pid_infant), function(i) {
  nm <- names(sheet_to_r_pid_infant)[i]
  val <- sheet_to_r_pid_infant[i]
  setNames(sheet_to_r_pid_infant_anele[[nm]] != val, NULL)
}) %>%
  all()
```

The datasets were given later than `Copy of delayed BCG samples for Anele_.xlsx`, and have the pids joined on for all infants, and so they're presumed to be correct. 

This means that the R pids constructed based on the ordering of the infants are incorrect for `data_tidy_clin_infant` thus far, and so `sheet_to_r_pid_infant` is also incorrect. We therefore use the labelling vector `sheet_to_r_pid_infant_anele` to get correct R pids in `data_tidy_clin_infant`. 
```{r , include = FALSE}
data_tidy_clin_infant <- data_tidy_clin_infant %>%
  dplyr::mutate(pid = sheet_to_r_pid_infant_anele[pid_sheet])

data_tidy_clin_infant <- data_tidy_clin_infant_anele %>%
  dplyr::rename(pid = pid_r_anele) %>%
  dplyr::full_join(
    data_tidy_clin_infant, 
    by = c("pid", "pid_sheet", "race", "bcg")
  ) %>%
  dplyr::arrange(pid) %>%
  dplyr::select(pid, pid_sheet, age, bcg, race, sex,
                visit_age, gest_age:head_circ, everything()) 
```

The above seems correct when checked manually against `Copy of delayed BCG samples for Anele_.xlsx` and `2021_09_16,Gela,email-Fig. 2 Frequencies.xlsx` spreadsheeet `IFNg+ CD4 T cells`.

```{r }
testthat::expect_identical(nrow(data_tidy_clin_infant), 75L)
testthat::expect_identical(sum(data_tidy_clin_infant$bcg == "bcg"), 50L)
testthat::expect_identical(sort(unique(data_tidy_clin_infant$race)),
                           c("1", "2"))
testthat::expect_identical(sort(unique(data_tidy_clin_infant$sex)),
                           c("1", "2"))
testthat::expect_identical(sort(unique(data_tidy_clin_infant$bcg)),
                           c("bcg", "no bcg"))
```

##### Set sex and race back to character entries

Set race and gender levels to descriptive words rather than numbers.

```{r , include = FALSE}
num_to_chr_race_infant <- setNames(names(chr_to_num_race_infant), 
                                   chr_to_num_race_infant)
short_to_long_sex_infant_anele <- c("F" = "female", "M" = "male")
num_to_chr_sex_infant <- setNames(short_to_long_sex_infant_anele[names(chr_to_num_sex_infant_anele)],
                                  chr_to_num_sex_infant_anele)
data_tidy_clin_infant <- data_tidy_clin_infant %>%
  dplyr::mutate(
    sex = num_to_chr_sex_infant[sex],
    race = num_to_chr_race_infant[race]
  )
```

##### Correct race, sex and visit_age for BCG-vaccinated infants

```{r , include = FALSE}
data_tidy_clin_infant_bcg <- data_tidy_clin_infant %>%
  dplyr::filter(bcg == "bcg")
data_tidy_clin_infant_bcg <- data_tidy_clin_infant_bcg %>%
  dplyr::mutate(
    pid = sheet_to_r_pid_infant_ifng[pid_sheet], 
    race = pid_to_race_inf_bcg[pid], 
    sex = pid_to_sex_inf_bcg[pid], 
    sex = short_to_long_sex_infant_anele[sex],
    visit_age = pid_to_visit_age_inf_bcg[pid], 
  ) 
data_tidy_clin_infant <- data_tidy_clin_infant %>%
  dplyr::filter(bcg == "no bcg") %>%
  dplyr::bind_rows(
    data_tidy_clin_infant_bcg
  )
```

##### Final adjustments

Place categorical variables first, and then continuous variables. 
```{r , include = FALSE}
data_tidy_clin_infant <- data_tidy_clin_infant %>%
  dplyr::select(pid, bcg, age, race, sex, everything()) %>%
  dplyr::select(-pid_sheet)
```

##### Add data for three extra infants

Three infants were included in the `data_tidy_freq_ifng` dataset that are not found elsewhere. Their clinical data are added here. 

```{r }
path_data_raw <- file.path(
  dir_data_raw, 
  "2021_10_14,Murphy,email-Clinical data-9W DBCG.xlsx"
)
data_tidy_clin_infant_add <- readxl::read_xlsx(
  path_data_raw
  ) %>%
  dplyr::rename(pid_sheet = `ID (D-BCG)`) %>%
  dplyr::rename(bcg = Status) %>%
  dplyr::mutate(
    bcg = purrr::map_chr(bcg, function(x) {
      switch(
        x, 
        "Vaccinated" = "bcg", 
        "Unvaccinated" = "no bcg", 
        x
      )
    })
  ) %>%
  dplyr::select(-Group) %>%
  dplyr::rename(
    race = Race, 
    sex = Sex, 
    visit_age = Weeks
  ) %>%
  dplyr::mutate(
    sex = purrr::map_chr(sex, function(x) {
      switch(
        x, 
        "M" = "male",
        "F" = "female",
        x
      )
    })
  ) %>%
  dplyr::mutate(
    pid_sheet = as.character(pid_sheet)
  ) %>%
  dplyr::mutate(
    pid = sheet_to_r_pid_infant_ifng[pid_sheet],
    pid = ifelse(is.na(pid), pid_sheet, pid)
    ) %>%
    dplyr::mutate(
      pid = purrr::map_chr(pid, function(x) {
        switch(
          x, 
          "3103" = "infant_76", 
          "5078" = "infant_77", 
          "5139" = "infant_78", 
          x
        )
      })
    ) %>%
  dplyr::mutate(age = "infant") %>%
  dplyr::select(pid, bcg, race, sex, visit_age)

data_tidy_clin_infant <- data_tidy_clin_infant %>%
  dplyr::bind_rows(
    data_tidy_clin_infant_add %>%
      dplyr::filter(
        !pid %in% data_tidy_clin_infant$pid
      )
  )

data_tidy_clin_infant <- data_tidy_clin_infant %>%
  dplyr::mutate(age = "infant")
```

##### Remove unused and very descriptive columns. 

```{r }
data_tidy_clin_infant <- data_tidy_clin_infant %>%
  dplyr::select(-c(visit_age, gest_age, weight, length, head_circ))
```

##### View

```{r }
datautils::view_cols(
  data_tidy_clin_infant
)
```

```{r , include = FALSE}
usethis::use_data(data_tidy_clin_infant, 
                  overwrite = TRUE)
```

```{r }
readr::write_csv(
  x = data_tidy_clin_infant, 
  file = file.path(dir_save_csv, "data_tidy_clin_infant.csv")
)
```


## Clinical data - Adults

### TBRU samples for Anele .xlsx

We read in the clinical data from `TBRU samples for Anele .xlsx`. This was the spreadsheet originally provided to give clinical data for the adults. We also compare it to the same read read in using different code, as well as another spreadsheet, to check that we are correct. 

```{r , include = FALSE}
path_data_raw <- file.path(
  dir_data_raw, 
  "TBRU samples for Anele .xlsx"
)
data_label_clin_adult <- readxl::read_xlsx(
  path_data_raw, 
  skip = 1, 
  n_max = 25,
  sheet = "TBRU samples"
  ) %>%
  dplyr::mutate(age = "adult") %>%
  dplyr::mutate(row = seq_len(dplyr::n())) %>%
  dplyr::mutate(row = ifelse(
      str_length(row) == 1, 
      paste0("0", row),
      row)) %>%
  dplyr::mutate(pid = paste0(age, "_", row)) %>%
  dplyr::select(-c(row, age)) %>%
  dplyr::select(pid, `Sample ID`)
sheet_to_r_pid_adult <- setNames(
  data_label_clin_adult$pid, 
  data_label_clin_adult$`Sample ID`
)
data_label_clin_adult <- readxl::read_xlsx(
  path_data_raw, 
  skip = 1, 
  n_max = 25,
  sheet = "TBRU samples"
  )
data_tidy_clin_adult <- readxl::read_xlsx(
  path_data_raw, 
  skip = 1, 
  n_max = 25,
  sheet = "Acquired TBRU samples"
  ) %>%
  dplyr::rename(age_in_years = age, 
                pid_sheet = `Sample ID`,
                ppd = PPDmm) %>%
  dplyr::mutate(age = "adult") %>%
  dplyr::mutate(row = seq_len(dplyr::n())) %>%
  dplyr::mutate(row = ifelse(
      str_length(row) == 1, 
      paste0("0", row),
      row)) %>%
  dplyr::mutate(pid = paste0(age, "_", row)) %>%
  dplyr::select(-c(row)) %>%
  dplyr::select(pid, pid_sheet, age, age_in_years, sex, race,
                hgbval, bcgscar, height, weight, ppd) 

data_tidy_clin_adult_lab <- data_tidy_clin_adult %>%
  dplyr::group_by(pid_sheet, pid) %>%
  dplyr::slice(1) %>%
  dplyr::ungroup() %>%
  dplyr::select(pid_sheet, pid)

r_to_sheet_pid_adult <- setNames(data_tidy_clin_adult_lab$pid_sheet, 
                                 data_tidy_clin_adult_lab$pid)

r_to_sheet_pid <- c(
  r_to_sheet_pid_infant, 
  r_to_sheet_pid_adult
)
sheet_to_r_pid <- setNames(
  names(r_to_sheet_pid), 
  r_to_sheet_pid
)

data_tidy_clin_adult <- data_tidy_clin_adult %>%
  dplyr::select(-pid_sheet)

data_tidy_clin_adult <- data_tidy_clin_adult %>%
  dplyr::mutate(race = ifelse(race == 2, 3, race)) %>%
  dplyr::mutate(sex = as.character(sex), 
                race = as.character(race), 
                bcgscar = as.character(bcgscar))

#num_to_chr_sex_adult <- c("1" = "male", "2" = "female")
#num_to_chr_race_adult <- c("3" = "non_african", "1" = "african")
data_tidy_clin_adult <- data_tidy_clin_adult %>%
  dplyr::mutate(race = ifelse(race == "3", "2", race))# %>%
  #dplyr::mutate(sex = num_to_chr_sex_adult[sex],
   #             race = num_to_chr_race_adult[race])

data_tidy_clin_adult <- data_tidy_clin_adult %>%
  dplyr::select(-bcgscar)
```

#### Checks

##### Against itself

```{r }
testthat::expect_identical(nrow(data_tidy_clin_adult), 25L)
testthat::expect_identical(sum(data_tidy_clin_adult$age == "adult"), 25L)
testthat::expect_identical(sort(unique(data_tidy_clin_adult$race)),
                           c("1", "2"))
testthat::expect_identical(sort(unique(data_tidy_clin_adult$sex)),
                           c("1", "2"))
```

##### Comparison of clinical data with previous development and manual

```{r , include = FALSE}
path_data_raw <- file.path(
  dir_data_raw, 
  "TBRU samples for Anele .xlsx"
)
data_label_clin_adult_orig <- readxl::read_xlsx(
  path_data_raw, 
  skip = 1, 
  n_max = 25,
  sheet = "TBRU samples"
  ) %>%
  dplyr::mutate(age = "adult") %>%
  dplyr::mutate(row = seq_len(dplyr::n())) %>%
  dplyr::mutate(row = ifelse(
      str_length(row) == 1, 
      paste0("0", row),
      row)) %>%
  dplyr::mutate(pid = paste0(age, "_", row)) %>%
  dplyr::select(-c(row, age)) %>%
  dplyr::select(pid, `Sample ID`)
sheet_to_r_pid_adult_orig <- setNames(
  data_label_clin_adult_orig$pid, 
  data_label_clin_adult_orig$`Sample ID`
)

data_tidy_clin_adult_orig <- readxl::read_xlsx(
  path_data_raw, 
  skip = 1, 
  n_max = 25,
  sheet = "Acquired TBRU samples"
  ) %>%
  dplyr::rename(age_in_years = age) %>%
  dplyr::mutate(age = "adult") %>%
  dplyr::mutate(row = seq_len(dplyr::n())) %>%
  dplyr::mutate(row = ifelse(
      str_length(row) == 1, 
      paste0("0", row),
      row)) %>%
  dplyr::mutate(pid = paste0(age, "_", row)) %>%
  dplyr::select(-c(row)) %>%
  dplyr::select(pid, age, age_in_years, sex,
                race, hgbval, bcgscar, height,
                weight, PPDmm) %>%
  dplyr::rename(ppd = PPDmm)
data_tidy_clin_adult_orig <- data_tidy_clin_adult_orig %>%
  dplyr::mutate(race = ifelse(race == 2, 3, race)) %>%
  dplyr::mutate(sex = as.character(sex), 
                race = as.character(race), 
                bcgscar = as.character(bcgscar))

num_to_chr_sex_adult <- c("1" = "male", "2" = "female")
num_to_chr_race_adult <- c("3" = "non_african", "1" = "african")
data_tidy_clin_adult_orig <- data_tidy_clin_adult_orig %>%
  dplyr::mutate(race = ifelse(race == "2", "3", race))

data_tidy_clin_adult_orig <- data_tidy_clin_adult_orig %>%
  dplyr::select(-bcgscar)
```

```{r , include = FALSE}
data_tidy_clin_adult_orig_cat <- data_tidy_clin_adult_orig %>%
  dplyr::select(pid, sex, race, age) %>%
  dplyr::mutate(sex = setNames(names(num_to_chr_sex_adult), 
                               num_to_chr_sex_adult)[sex]) %>%
  dplyr::mutate(race = setNames(names(num_to_chr_race_adult), 
                               num_to_chr_race_adult)[race]) %>%
  tidyr::pivot_longer(
    -pid,
    names_to = "var_cat", 
    values_to = "value"
  ) %>%
  dplyr::mutate(type = "orig")

data_tidy_clin_adult_cat <- data_tidy_clin_adult %>%
  dplyr::select(pid, sex, race, age) %>%
  tidyr::pivot_longer(
    -pid,
    names_to = "var_cat", 
    values_to = "value"
  ) %>%
  dplyr::mutate(type = "latest")

sheet_vec <- c(
  "MAIT cells", 
  "NKT cells", 
  "CD1b-GMM", 
  "gd T cells", 
  "CD4 T cells"
)

# read in Anele's clinical data
path_data_raw <- file.path(
  dir_data_raw, 
  "2021_09_16,Gela,email-Fig. 2 Frequencies.xlsx"
)
data_tidy_clin_adult_anele <- readxl::read_xlsx(
  file.path(
    path_data_raw 
  ), 
  sheet = "MAIT cells", 
  n_max = 25,
) %>%
  dplyr::select(`Sample ID`, age:height) %>%
  dplyr::mutate(
    age = "adult",
  )  %>%
  dplyr::mutate(`Sample ID` = as.character(`Sample ID`)) %>%
  dplyr::rename(pid_sheet = `Sample ID`) %>%
  dplyr::mutate(pid = sheet_to_r_pid[pid_sheet]) %>%
  dplyr::mutate(sex = as.character(sex), 
                race = as.character(race), 
                bcgscar = as.character(bcgscar)) %>%
  dplyr::mutate(race = ifelse(race == "2", "3", race)) %>%
  dplyr::rename(ppd = PPDmm) %>%
  dplyr::select(-pid_sheet)

data_tidy_clin_adult_anele_cat <- data_tidy_clin_adult_anele %>%
  dplyr::select(pid, sex, race, age) %>%
  tidyr::pivot_longer(
    -pid,
    names_to = "var_cat", 
    values_to = "value"
  ) %>%
  dplyr::mutate(type = "anele")

data_tidy_clin_adult_anele_cont <- data_tidy_clin_adult_anele %>%
  dplyr::select(-c(sex, race, age, bcgscar)) %>%
  tidyr::pivot_longer(
    -pid, 
    names_to = "var",
    values_to = "value"
  ) %>%
  dplyr::mutate(type = "anele")
```

The tables below display the mismatches between the different datasets read in for the adult clinical data. There are none. 

```{r }
tidy_clin_adult_cat_comp <- data_tidy_clin_adult_orig_cat %>%
  dplyr::bind_rows(data_tidy_clin_adult_cat) %>%
  dplyr::bind_rows(data_tidy_clin_adult_anele_cat) %>%
  tidyr::pivot_wider(
    names_from = "type", 
    values_from = "value"
  ) %>%
  dplyr::filter(orig != latest | anele != orig)
tidy_clin_adult_cat_comp
```

```{r }
data_tidy_clin_adult_orig_cont <- data_tidy_clin_adult_orig %>%
  dplyr::select(-c(sex, race, age)) %>%
  tidyr::pivot_longer(
    -pid, 
    names_to = "var",
    values_to = "value"
  ) %>%
  dplyr::mutate(type = "orig")

data_tidy_clin_adult_cont <- data_tidy_clin_adult %>%
  dplyr::select(-c(sex, race, age)) %>%
  tidyr::pivot_longer(
    -pid, 
    names_to = "var",
    values_to = "value"
  ) %>%
  dplyr::mutate(type = "latest")

tidy_clin_adult_cont_comp <- data_tidy_clin_adult_orig_cont %>%
  dplyr::bind_rows(data_tidy_clin_adult_cont) %>%
  dplyr::bind_rows(data_tidy_clin_adult_anele_cont) %>%
  tidyr::pivot_wider(
    names_from = "type", 
    values_from = "value"
  ) %>%
  dplyr::filter(orig != latest | anele != orig)
tidy_clin_adult_cont_comp
```

#### Final adjustments

Set race and gender levels to descriptive words rather than numbers.

```{r , include = FALSE}
data_tidy_clin_adult <- data_tidy_clin_adult %>%
  dplyr::mutate(
    sex = num_to_chr_sex_adult[sex],
    race = purrr::map_chr(race, function(x) {
      if(x == "2") return("non_black")
      "black"
    })
  )
```

Place categorial variables first, and then continuous variables. 
```{r , include = FALSE}
data_tidy_clin_adult <- data_tidy_clin_adult %>%
  dplyr::select(pid, age, sex, race, everything())
```

##### Remove unused and very descriptive columns. 

```{r }
data_tidy_clin_adult <- data_tidy_clin_adult %>%
  dplyr::select(-c(age_in_years, hgbval, height, weight, ppd))
```

#### View

```{r }
datautils::view_cols(
  data_tidy_clin_adult
)
```

```{r , include = FALSE}
usethis::use_data(data_tidy_clin_adult, 
                  overwrite = TRUE)
```

```{r }
readr::write_csv(
  x = data_tidy_clin_adult, 
  file = file.path(dir_save_csv, "data_tidy_clin_adult.csv")
)
```

## Zip files together

```{r }
wd <- getwd()
if (!identical(basename(wd), "DataTidyGelaDURT")) {
  setwd(dirname(wd))
}

# zip files to save to 
file_save_csv <- file.path(
  dirname(dir_save_csv), "data_raw-csv.zip"
  )

file_save_help <- file.path(
  dirname(dir_save_csv), "data_raw-help.zip"
  )

file_save_pkg_win <- file.path(
  dirname(dir_save_csv), "data_raw-r_pkg-windows_only.zip"
)

file_save_pkg_any <- file.path(
  dirname(dir_save_csv), "data_raw-r_pkg-any_platform.zip"
)

# build package so that you can 
# extract help docs
devtools::install(pkg = here::here(), upgrade = "never")

# help docs
dir_help <- system.file(
  "html", package = "DataTidyGelaDURT"
  )
file_vec <- list.files(dir_help, full.names = TRUE, 
                       pattern = "html$")

if (file.exists(file_save_help)) unlink(file_save_help, recursive = TRUE)

zip::zip(
  zipfile = file_save_help, 
  files = file_vec, 
  mode = "cherry-pick"
)

# raw data
file_vec <- list.files(dir_save_csv, full.names = TRUE, 
                       pattern = "csv$")

if (file.exists(file_save_csv)) unlink(file_save_csv, recursive = TRUE)

zip::zip(
  zipfile = file_save_csv, 
  files = file_vec, 
  mode = "cherry-pick"
)

# build package for all platforms
devtools::build(
  pkg = here::here(), 
  binary = FALSE
)
if (file.exists(file.path(dirname(dir_save_csv), "DataTidyGelaDURT_0.1.0.tar.gz"))) {
  file.remove(file.path(dirname(dir_save_csv), "DataTidyGelaDURT_0.1.0.tar.gz"))
}
file.copy(
  file.path(dirname(getwd()), "DataTidyGelaDURT_0.1.0.tar.gz"), 
  file.path(dirname(dir_save_csv), "DataTidyGelaDURT_0.1.0.tar.gz")
)
file.remove(file.path(dirname(getwd()), "DataTidyGelaDURT_0.1.0.tar.gz"))

# build package for Windows
if (file.exists(file.path(dirname(dir_save_csv), "DataTidyGelaDURT_0.1.0.zip"))) {
  file.remove(file.path(dirname(dir_save_csv), "DataTidyGelaDURT_0.1.0.zip"))
}
devtools::build(
  pkg = here::here(), 
  binary = TRUE
)
file.copy(
  file.path(dirname(getwd()), "DataTidyGelaDURT_0.1.0.zip"), 
  file.path(dirname(dir_save_csv), "DataTidyGelaDURT_0.1.0.zip")
)
file.remove(file.path(dirname(getwd()), "DataTidyGelaDURT_0.1.0.zip"))
setwd(wd)
```
